name: PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled, closed]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  orgs: read

jobs:
  validate-pr:
    name: Validate PR
    runs-on: oci-hosted
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'deploy-preview') ||
      (github.event.action == 'unlabeled' && github.event.label.name == 'deploy-preview') ||
      (github.event.action == 'opened' && contains(github.event.pull_request.labels.*.name, 'deploy-preview')) ||
      (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'deploy-preview')) ||
      (github.event.action == 'closed')
    outputs:
      pr_number: ${{ steps.get-pr.outputs.number }}
      is_fork: ${{ steps.check-fork.outputs.is_fork }}
      is_collaborator: ${{ steps.check-collaborator.outputs.is_collaborator }}
      should_deploy: ${{ steps.decide.outputs.should_deploy }}
      should_teardown: ${{ steps.decide.outputs.should_teardown }}
    steps:
      - name: Get PR number
        id: get-pr
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR Number: $PR_NUMBER"

      - name: Check if PR is from fork
        id: check-fork
        run: |
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ PR is from a fork: $HEAD_REPO"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "âœ“ PR is from same repository"
          fi

      - name: Verify team exists and is accessible
        id: verify-team
        if: steps.check-fork.outputs.is_fork == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG: Neuro-D3
          TEAM_SLUG: d3-developers
        run: |
          echo "Verifying team '$TEAM_SLUG' exists and is accessible in org '$ORG'..."
          
          # Check if team exists and is accessible
          # GET /orgs/{org}/teams/{team_slug}
          TEAM_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/$ORG/teams/$TEAM_SLUG")
          
          HTTP_CODE=$(echo "$TEAM_RESPONSE" | tail -n1)
          TEAM_BODY=$(echo "$TEAM_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Team '$TEAM_SLUG' exists and is accessible"
            echo "team_accessible=true" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "::error::Team '$TEAM_SLUG' not found in org '$ORG' (HTTP 404)"
            echo "This could mean:"
            echo "  - The team slug is incorrect"
            echo "  - The team doesn't exist"
            echo "  - Insufficient permissions to access the team"
            echo "team_accessible=false" >> $GITHUB_OUTPUT
            exit 1
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "::error::Insufficient permissions to access team '$TEAM_SLUG' (HTTP 403)"
            echo "The GITHUB_TOKEN may need 'orgs: read' permission, or use a PAT with 'read:org' scope"
            echo "team_accessible=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "::error::Unexpected error checking team accessibility (HTTP $HTTP_CODE)"
            echo "$TEAM_BODY"
            echo "team_accessible=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check actor team membership
        id: check-collaborator
        if: |
          steps.check-fork.outputs.is_fork == 'false' &&
          steps.verify-team.outputs.team_accessible == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTOR: ${{ github.actor }}
          ORG: Neuro-D3
          TEAM_SLUG: d3-developers
          ACTION: ${{ github.event.action }}
          LABEL_NAME: ${{ github.event.label.name }}
        run: |
          echo "Checking if '$ACTOR' is a member of team '$TEAM_SLUG' in org '$ORG'..."
          
          # Check team membership
          # GET /orgs/{org}/teams/{team_slug}/memberships/{username}
          # Returns 200 if member, 404 if not member or team doesn't exist
          # Since we verified team exists in previous step, 404 here means not a member
          MEMBERSHIP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/$ORG/teams/$TEAM_SLUG/memberships/$ACTOR")
          
          HTTP_CODE=$(echo "$MEMBERSHIP_RESPONSE" | tail -n1)
          MEMBERSHIP_BODY=$(echo "$MEMBERSHIP_RESPONSE" | sed '$d')
          
          IS_COLLABORATOR="false"
          
          if [ "$HTTP_CODE" = "200" ]; then
            # Extract state from response
            STATE=$(echo "$MEMBERSHIP_BODY" | grep -o '"state":"[^"]*"' | cut -d'"' -f4 || echo "inactive")
            
            if [ "$STATE" = "active" ]; then
              IS_COLLABORATOR="true"
              echo "âœ… Actor '$ACTOR' is an active member of team '$TEAM_SLUG'"
            else
              echo "::error::Actor '$ACTOR' is in team '$TEAM_SLUG' but membership state is '$STATE' (expected 'active')"
              echo "Membership details: $MEMBERSHIP_BODY"
            fi
          elif [ "$HTTP_CODE" = "404" ]; then
            # Team exists (verified in previous step), so 404 means actor is not a member
            IS_COLLABORATOR="false"
            echo "âŒ Actor '$ACTOR' is NOT a member of team '$TEAM_SLUG'"
            
            # Fail immediately if trying to add deploy-preview label
            if [ "$ACTION" = "labeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
              echo "::error::Access denied: Only members of the '$TEAM_SLUG' team can add the 'deploy-preview' label"
              exit 1
            fi
          else
            echo "::error::Unexpected error checking team membership (HTTP $HTTP_CODE)"
            echo "$MEMBERSHIP_BODY"
            exit 1
          fi
          
          # Set output
          echo "is_collaborator=$IS_COLLABORATOR" >> $GITHUB_OUTPUT

      - name: Decide action
        id: decide
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.number }}"
          IS_FORK="${{ steps.check-fork.outputs.is_fork }}"
          IS_COLLABORATOR="${{ steps.check-collaborator.outputs.is_collaborator }}"
          ACTION="${{ github.event.action }}"
          LABEL_NAME="${{ github.event.label.name }}"
          
          SHOULD_DEPLOY=false
          SHOULD_TEARDOWN=false
          
          # Only deploy if not a fork and is a collaborator
          if [ "$IS_FORK" = "false" ] && [ "$IS_COLLABORATOR" = "true" ]; then
            if [ "$ACTION" = "labeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
              SHOULD_DEPLOY=true
            elif [ "$ACTION" = "opened" ] || [ "$ACTION" = "synchronize" ]; then
              # Check if label exists
              if echo "${{ toJSON(github.event.pull_request.labels) }}" | grep -q "deploy-preview"; then
                SHOULD_DEPLOY=true
              fi
            fi
          fi
          
          # Teardown on label removal or PR close
          if [ "$ACTION" = "unlabeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
            SHOULD_TEARDOWN=true
          elif [ "$ACTION" = "closed" ]; then
            SHOULD_TEARDOWN=true
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "should_teardown=$SHOULD_TEARDOWN" >> $GITHUB_OUTPUT
          
          echo "Deploy: $SHOULD_DEPLOY"
          echo "Teardown: $SHOULD_TEARDOWN"

  cleanup-other-prs:
    name: Cleanup Other PR Previews
    runs-on: oci-hosted
    needs: validate-pr
    if: needs.validate-pr.outputs.should_deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and cleanup other PRs with deploy-preview label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_PR: ${{ needs.validate-pr.outputs.pr_number }}
        run: |
          REPO="${{ github.repository }}"
          CURRENT_PR_NUMBER="$CURRENT_PR"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          CADDY_API_URL="${{ vars.CADDY_API_URL || 'http://localhost:2019' }}"
          
          echo "Checking for other PRs with deploy-preview label..."
          
          # Get all open PRs with deploy-preview label
          PRS_WITH_LABEL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100" | \
            jq -r ".[] | select(.number != $CURRENT_PR_NUMBER) | select(.labels[]?.name == \"deploy-preview\") | .number")
          
          # Also check for any running PR containers (deadlock prevention)
          echo "Checking for running PR containers..."
          RUNNING_PR_CONTAINERS=$(docker ps --format "{{.Names}}" | grep -E "^pr-[0-9]+-" | sed 's/pr-\([0-9]*\)-.*/\1/' | sort -u || true)
          
          if [ -z "$PRS_WITH_LABEL" ] && [ -z "$RUNNING_PR_CONTAINERS" ]; then
            echo "No other PRs with deploy-preview label or running containers found"
            exit 0
          fi
          
          # Combine PR numbers from labels and running containers
          ALL_PR_NUMBERS=$(echo -e "$PRS_WITH_LABEL\n$RUNNING_PR_CONTAINERS" | grep -v '^$' | sort -u)
          
          if [ -z "$ALL_PR_NUMBERS" ]; then
            echo "No other PRs to clean up"
            exit 0
          fi
          
          echo "Found PRs to clean up: $ALL_PR_NUMBERS"
          
          # For each PR, remove label and tear down
          for PR_NUMBER in $ALL_PR_NUMBERS; do
            echo "Cleaning up PR #$PR_NUMBER..."
            
            # Remove deploy-preview label if it exists
            LABEL_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/labels" | \
              jq -r '.[] | select(.name == "deploy-preview") | .name' || echo "")
            
            if [ -n "$LABEL_EXISTS" ]; then
              curl -X DELETE \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/labels/deploy-preview" || true
              echo "Removed deploy-preview label from PR #$PR_NUMBER"
            fi
            
            # Tear down the environment
            PROJECT_NAME="pr-$PR_NUMBER"
            
            # Remove Caddy routes
            if [ -f deploy/scripts/remove-routes.sh ]; then
              chmod +x deploy/scripts/remove-routes.sh
              ./deploy/scripts/remove-routes.sh "$PR_NUMBER" "$DOMAIN" || {
                echo "Failed to remove routes for PR #$PR_NUMBER, but continuing..."
              }
            fi
            
            # Stop and remove containers
            docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml down -v || {
              echo "Failed to tear down PR #$PR_NUMBER, but continuing..."
            }
            
            echo "âœ“ Cleaned up PR #$PR_NUMBER"
            
            # Comment on the PR if it's still open
            PR_STATE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER" | \
              jq -r '.state' || echo "unknown")
            
            if [ "$PR_STATE" = "open" ]; then
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                -d "{\"body\":\"## ðŸ”„ PR Preview Environment Removed\\n\\nThe \`deploy-preview\` label was removed from this PR because another PR (#$CURRENT_PR_NUMBER) now has the label. Only one PR can have a preview environment active at a time.\\n\\n---\\n*Automated cleanup by GitHub Actions*\"}" || true
            fi
          done
          
          echo "âœ“ Cleanup complete"

  deploy:
    name: Deploy PR Preview
    runs-on: oci-hosted
    needs: [validate-pr, cleanup-other-prs]
    if: needs.validate-pr.outputs.should_deploy == 'true'
    environment:
      name: pr-preview
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up environment
        run: |
          PR_NUMBER="${{ needs.validate-pr.outputs.pr_number }}"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
          echo "PROJECT_NAME=pr-$PR_NUMBER" >> $GITHUB_ENV

      - name: Check for running PR containers (deadlock prevention)
        run: |
          echo "Checking for any running PR containers before deploying..."
          RUNNING_CONTAINERS=$(docker ps --format "{{.Names}}" | grep -E "^pr-[0-9]+-" || true)
          
          if [ -n "$RUNNING_CONTAINERS" ]; then
            echo "::warning::Found running PR containers. They should have been cleaned up, but stopping them now:"
            echo "$RUNNING_CONTAINERS"
            
            # Extract PR numbers and stop them
            for CONTAINER in $RUNNING_CONTAINERS; do
              PR_NUM=$(echo "$CONTAINER" | sed 's/pr-\([0-9]*\)-.*/\1/')
              if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "$PR_NUMBER" ]; then
                echo "Stopping containers for PR #$PR_NUM..."
                docker compose -p "pr-$PR_NUM" -f docker-compose.pr.yml down -v || true
              fi
            done
          else
            echo "âœ“ No other PR containers running"
          fi

      - name: Build and deploy
        env:
          REACT_APP_API_URL: https://pr-${{ needs.validate-pr.outputs.pr_number }}.api.${{ env.DOMAIN }}
        run: |
          echo "Building and deploying PR #$PR_NUMBER..."
          docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml up -d --build
          
          echo "Waiting for services to start..."
          sleep 10

      - name: Health check
        run: |
          chmod +x deploy/scripts/health-check.sh
          ./deploy/scripts/health-check.sh "$PR_NUMBER" || {
            echo "Health check failed, but continuing..."
          }

      - name: Register Caddy routes
        env:
          CADDY_API_URL: ${{ vars.CADDY_API_URL || 'http://localhost:2019' }}
        run: |
          chmod +x deploy/scripts/register-routes.sh
          ./deploy/scripts/register-routes.sh "$PR_NUMBER" "$DOMAIN"

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ needs.validate-pr.outputs.pr_number }}
          DOMAIN: ${{ env.DOMAIN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = process.env.PR_NUMBER;
            const domain = process.env.DOMAIN;
            
            const comment = `## ðŸš€ PR Preview Environment Deployed
            
            Your preview environment is now available at:
            
            - **Airflow**: https://pr-${prNumber}.airflow.${domain}
            - **Frontend App**: https://pr-${prNumber}.app.${domain}
            - **API**: https://pr-${prNumber}.api.${domain}
            - **pgAdmin**: https://pr-${prNumber}.pgadmin.${domain}
            
            > **Note**: This environment will be automatically torn down when the PR is closed or the \`deploy-preview\` label is removed. Only one PR can have a preview environment active at a time.
            
            ---
            *Deployed by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  teardown:
    name: Teardown PR Preview
    runs-on: oci-hosted
    needs: validate-pr
    if: needs.validate-pr.outputs.should_teardown == 'true'
    steps:
      - name: Set up environment
        run: |
          PR_NUMBER="${{ needs.validate-pr.outputs.pr_number }}"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
          echo "PROJECT_NAME=pr-$PR_NUMBER" >> $GITHUB_ENV

      - name: Remove Caddy routes
        env:
          CADDY_API_URL: ${{ vars.CADDY_API_URL || 'http://localhost:2019' }}
        run: |
          chmod +x deploy/scripts/remove-routes.sh
          ./deploy/scripts/remove-routes.sh "$PR_NUMBER" || {
            echo "Failed to remove routes, but continuing..."
          }

      - name: Stop and remove containers
        run: |
          echo "Tearing down PR #$PR_NUMBER..."
          docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml down -v || {
            echo "Failed to tear down, but continuing..."
          }

      - name: Comment on PR
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ needs.validate-pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = process.env.PR_NUMBER;
            
            const comment = `## ðŸ§¹ PR Preview Environment Removed
            
            The preview environment for this PR has been torn down and all resources have been cleaned up.
            
            ---
            *Cleaned up by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

