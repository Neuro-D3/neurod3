name: PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled, closed]
  workflow_dispatch:

jobs:
  validate-pr:
    name: Validate PR
    runs-on: oci-hosted
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'deploy-preview') ||
      (github.event.action == 'unlabeled' && github.event.label.name == 'deploy-preview') ||
      (github.event.action == 'opened' && contains(github.event.pull_request.labels.*.name, 'deploy-preview')) ||
      (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'deploy-preview')) ||
      (github.event.action == 'closed')
    outputs:
      pr_number: ${{ steps.get-pr.outputs.number }}
      is_fork: ${{ steps.check-fork.outputs.is_fork }}
      is_collaborator: ${{ steps.check-collaborator.outputs.is_collaborator }}
      should_deploy: ${{ steps.decide.outputs.should_deploy }}
      should_teardown: ${{ steps.decide.outputs.should_teardown }}
    steps:
      - name: Get PR number
        id: get-pr
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR Number: $PR_NUMBER"

      - name: Check if PR is from fork
        id: check-fork
        run: |
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ PR is from a fork: $HEAD_REPO"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "âœ“ PR is from same repository"
          fi

      - name: Install jq (if needed)
        if: steps.check-fork.outputs.is_fork == 'false'
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq && sudo apt-get install -y -qq jq || {
              echo "Failed to install jq, will use alternative method"
            }
          else
            echo "jq is already installed"
          fi

      - name: Check if actor is in D3-Developers team
        id: check-collaborator
        if: steps.check-fork.outputs.is_fork == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          ACTION="${{ github.event.action }}"
          LABEL_NAME="${{ github.event.label.name }}"
          
          # Extract organization name from repository (format: org/repo)
          ORG=$(echo "$REPO" | cut -d'/' -f1)
          
          echo "Checking if $ACTOR is a member of D3-Developers team in org $ORG..."
          
          # Try multiple possible slugs
          TEAM_SLUGS=("d3-developers" "D3-Developers" "D3-developers" "d3-Developers")
          TEAM_SLUG=""
          
          # Try each slug to see which one exists
          for slug in "${TEAM_SLUGS[@]}"; do
            HTTP_TEST=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/$ORG/teams/$slug")
            if [ "$HTTP_TEST" = "200" ]; then
              TEAM_SLUG="$slug"
              echo "Found team with slug: $TEAM_SLUG"
              break
            fi
          done
          
          # If still not found, try to search through all teams
          if [ -z "$TEAM_SLUG" ]; then
            echo "Searching through all teams..."
            TEAMS_RESPONSE=$(curl -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/$ORG/teams?per_page=100")
            
            # Try to find team using grep (works without jq)
            if echo "$TEAMS_RESPONSE" | grep -qi "d3.*developers\|developers.*d3"; then
              # Extract slug using grep/sed (more reliable than jq for this case)
              TEAM_SLUG=$(echo "$TEAMS_RESPONSE" | grep -i "d3.*developers\|developers.*d3" | grep -o '"slug":"[^"]*"' | head -n1 | cut -d'"' -f4)
              
              if [ -n "$TEAM_SLUG" ] && [ "$TEAM_SLUG" != "null" ]; then
                echo "Found team with slug: $TEAM_SLUG"
              fi
            fi
            
            # If jq is available, also try with jq as a backup
            if [ -z "$TEAM_SLUG" ] && command -v jq &> /dev/null; then
              # Validate JSON first
              if echo "$TEAMS_RESPONSE" | jq empty 2>/dev/null; then
                # Check if it's an array
                IS_ARRAY=$(echo "$TEAMS_RESPONSE" | jq -r 'if type == "array" then "true" else "false" end' 2>/dev/null)
                if [ "$IS_ARRAY" = "true" ]; then
                  TEAM_SLUG=$(echo "$TEAMS_RESPONSE" | jq -r '.[] | select(.name | test("(?i)d3.*developers|developers.*d3")) | .slug' 2>/dev/null | head -n1)
                  if [ -n "$TEAM_SLUG" ] && [ "$TEAM_SLUG" != "null" ]; then
                    echo "Found team with slug (via jq): $TEAM_SLUG"
                  fi
                fi
              fi
            fi
          fi
          
          if [ -z "$TEAM_SLUG" ] || [ "$TEAM_SLUG" = "null" ] || [ "$TEAM_SLUG" = "" ]; then
            echo "::error::Could not find D3-Developers team in organization $ORG"
            echo "Tried slugs: ${TEAM_SLUGS[*]}"
            echo "Raw API response (first 500 chars):"
            echo "$TEAMS_RESPONSE" | head -c 500
            echo ""
            exit 1
          fi
          
          # Check if user is a member of the organization team
          # API endpoint: GET /orgs/{org}/teams/{team_slug}/memberships/{username}
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/$ORG/teams/$TEAM_SLUG/memberships/$ACTOR")
          
          IS_COLLABORATOR="false"
          
          if [ "$HTTP_CODE" = "200" ]; then
            # User is a team member, check their role in the team
            MEMBERSHIP_RESPONSE=$(curl -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/$ORG/teams/$TEAM_SLUG/memberships/$ACTOR")
            
            if command -v jq &> /dev/null; then
              ROLE=$(echo "$MEMBERSHIP_RESPONSE" | jq -r '.role // "member"')
              STATE=$(echo "$MEMBERSHIP_RESPONSE" | jq -r '.state // "inactive"')
            else
              # Fallback: use grep to extract values
              ROLE=$(echo "$MEMBERSHIP_RESPONSE" | grep -o '"role":"[^"]*"' | cut -d'"' -f4 || echo "member")
              STATE=$(echo "$MEMBERSHIP_RESPONSE" | grep -o '"state":"[^"]*"' | cut -d'"' -f4 || echo "inactive")
            fi
            
            if [ "$STATE" = "active" ]; then
              IS_COLLABORATOR="true"
              echo "âœ“ Actor $ACTOR is an active member of team $TEAM_SLUG (role: $ROLE)"
            else
              echo "âœ— Actor $ACTOR is in team $TEAM_SLUG but state is $STATE"
            fi
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âœ— Actor $ACTOR is not a member of team $TEAM_SLUG (HTTP 404)"
            if command -v jq &> /dev/null; then
              echo "Team members:"
              curl -s \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/orgs/$ORG/teams/$TEAM_SLUG/members" | \
                jq -r '.[] | "  - \(.login)"' || echo "  (Could not list members)"
            fi
          else
            echo "âœ— Error checking team membership (HTTP $HTTP_CODE)"
            # If there's an API error, we'll be conservative and deny access
          fi
          
          # Set output
          echo "is_collaborator=$IS_COLLABORATOR" >> $GITHUB_OUTPUT
          
          # Fail if non-team-member tries to add the deploy-preview label
          if [ "$ACTION" = "labeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
            if [ "$IS_COLLABORATOR" != "true" ]; then
              echo "::error::Only members of the D3-Developers team can add the 'deploy-preview' label"
              exit 1
            fi
          fi

      - name: Decide action
        id: decide
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.number }}"
          IS_FORK="${{ steps.check-fork.outputs.is_fork }}"
          IS_COLLABORATOR="${{ steps.check-collaborator.outputs.is_collaborator }}"
          ACTION="${{ github.event.action }}"
          LABEL_NAME="${{ github.event.label.name }}"
          
          SHOULD_DEPLOY=false
          SHOULD_TEARDOWN=false
          
          # Only deploy if not a fork and is a collaborator
          if [ "$IS_FORK" = "false" ] && [ "$IS_COLLABORATOR" = "true" ]; then
            if [ "$ACTION" = "labeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
              SHOULD_DEPLOY=true
            elif [ "$ACTION" = "opened" ] || [ "$ACTION" = "synchronize" ]; then
              # Check if label exists
              if echo "${{ toJSON(github.event.pull_request.labels) }}" | grep -q "deploy-preview"; then
                SHOULD_DEPLOY=true
              fi
            fi
          fi
          
          # Teardown on label removal or PR close
          if [ "$ACTION" = "unlabeled" ] && [ "$LABEL_NAME" = "deploy-preview" ]; then
            SHOULD_TEARDOWN=true
          elif [ "$ACTION" = "closed" ]; then
            SHOULD_TEARDOWN=true
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "should_teardown=$SHOULD_TEARDOWN" >> $GITHUB_OUTPUT
          
          echo "Deploy: $SHOULD_DEPLOY"
          echo "Teardown: $SHOULD_TEARDOWN"

  cleanup-other-prs:
    name: Cleanup Other PR Previews
    runs-on: oci-hosted
    needs: validate-pr
    if: needs.validate-pr.outputs.should_deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and cleanup other PRs with deploy-preview label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_PR: ${{ needs.validate-pr.outputs.pr_number }}
        run: |
          REPO="${{ github.repository }}"
          CURRENT_PR_NUMBER="$CURRENT_PR"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          CADDY_API_URL="${{ vars.CADDY_API_URL || 'http://localhost:2019' }}"
          
          echo "Checking for other PRs with deploy-preview label..."
          
          # Get all open PRs with deploy-preview label
          PRS_WITH_LABEL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100" | \
            jq -r ".[] | select(.number != $CURRENT_PR_NUMBER) | select(.labels[]?.name == \"deploy-preview\") | .number")
          
          # Also check for any running PR containers (deadlock prevention)
          echo "Checking for running PR containers..."
          RUNNING_PR_CONTAINERS=$(docker ps --format "{{.Names}}" | grep -E "^pr-[0-9]+-" | sed 's/pr-\([0-9]*\)-.*/\1/' | sort -u || true)
          
          if [ -z "$PRS_WITH_LABEL" ] && [ -z "$RUNNING_PR_CONTAINERS" ]; then
            echo "No other PRs with deploy-preview label or running containers found"
            exit 0
          fi
          
          # Combine PR numbers from labels and running containers
          ALL_PR_NUMBERS=$(echo -e "$PRS_WITH_LABEL\n$RUNNING_PR_CONTAINERS" | grep -v '^$' | sort -u)
          
          if [ -z "$ALL_PR_NUMBERS" ]; then
            echo "No other PRs to clean up"
            exit 0
          fi
          
          echo "Found PRs to clean up: $ALL_PR_NUMBERS"
          
          # For each PR, remove label and tear down
          for PR_NUMBER in $ALL_PR_NUMBERS; do
            echo "Cleaning up PR #$PR_NUMBER..."
            
            # Remove deploy-preview label if it exists
            LABEL_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/labels" | \
              jq -r '.[] | select(.name == "deploy-preview") | .name' || echo "")
            
            if [ -n "$LABEL_EXISTS" ]; then
              curl -X DELETE \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/labels/deploy-preview" || true
              echo "Removed deploy-preview label from PR #$PR_NUMBER"
            fi
            
            # Tear down the environment
            PROJECT_NAME="pr-$PR_NUMBER"
            
            # Remove Caddy routes
            if [ -f deploy/scripts/remove-routes.sh ]; then
              chmod +x deploy/scripts/remove-routes.sh
              ./deploy/scripts/remove-routes.sh "$PR_NUMBER" "$DOMAIN" || {
                echo "Failed to remove routes for PR #$PR_NUMBER, but continuing..."
              }
            fi
            
            # Stop and remove containers
            docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml down -v || {
              echo "Failed to tear down PR #$PR_NUMBER, but continuing..."
            }
            
            echo "âœ“ Cleaned up PR #$PR_NUMBER"
            
            # Comment on the PR if it's still open
            PR_STATE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER" | \
              jq -r '.state' || echo "unknown")
            
            if [ "$PR_STATE" = "open" ]; then
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
                -d "{\"body\":\"## ðŸ”„ PR Preview Environment Removed\\n\\nThe \`deploy-preview\` label was removed from this PR because another PR (#$CURRENT_PR_NUMBER) now has the label. Only one PR can have a preview environment active at a time.\\n\\n---\\n*Automated cleanup by GitHub Actions*\"}" || true
            fi
          done
          
          echo "âœ“ Cleanup complete"

  deploy:
    name: Deploy PR Preview
    runs-on: oci-hosted
    needs: [validate-pr, cleanup-other-prs]
    if: needs.validate-pr.outputs.should_deploy == 'true'
    environment:
      name: pr-preview
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up environment
        run: |
          PR_NUMBER="${{ needs.validate-pr.outputs.pr_number }}"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
          echo "PROJECT_NAME=pr-$PR_NUMBER" >> $GITHUB_ENV

      - name: Check for running PR containers (deadlock prevention)
        run: |
          echo "Checking for any running PR containers before deploying..."
          RUNNING_CONTAINERS=$(docker ps --format "{{.Names}}" | grep -E "^pr-[0-9]+-" || true)
          
          if [ -n "$RUNNING_CONTAINERS" ]; then
            echo "::warning::Found running PR containers. They should have been cleaned up, but stopping them now:"
            echo "$RUNNING_CONTAINERS"
            
            # Extract PR numbers and stop them
            for CONTAINER in $RUNNING_CONTAINERS; do
              PR_NUM=$(echo "$CONTAINER" | sed 's/pr-\([0-9]*\)-.*/\1/')
              if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "$PR_NUMBER" ]; then
                echo "Stopping containers for PR #$PR_NUM..."
                docker compose -p "pr-$PR_NUM" -f docker-compose.pr.yml down -v || true
              fi
            done
          else
            echo "âœ“ No other PR containers running"
          fi

      - name: Build and deploy
        env:
          REACT_APP_API_URL: https://pr-${{ needs.validate-pr.outputs.pr_number }}.api.${{ env.DOMAIN }}
        run: |
          echo "Building and deploying PR #$PR_NUMBER..."
          docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml up -d --build
          
          echo "Waiting for services to start..."
          sleep 10

      - name: Health check
        run: |
          chmod +x deploy/scripts/health-check.sh
          ./deploy/scripts/health-check.sh "$PR_NUMBER" || {
            echo "Health check failed, but continuing..."
          }

      - name: Register Caddy routes
        env:
          CADDY_API_URL: ${{ vars.CADDY_API_URL || 'http://localhost:2019' }}
        run: |
          chmod +x deploy/scripts/register-routes.sh
          ./deploy/scripts/register-routes.sh "$PR_NUMBER" "$DOMAIN"

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ needs.validate-pr.outputs.pr_number }}
          DOMAIN: ${{ env.DOMAIN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = process.env.PR_NUMBER;
            const domain = process.env.DOMAIN;
            
            const comment = `## ðŸš€ PR Preview Environment Deployed
            
            Your preview environment is now available at:
            
            - **Airflow**: https://pr-${prNumber}.airflow.${domain}
            - **Frontend App**: https://pr-${prNumber}.app.${domain}
            - **API**: https://pr-${prNumber}.api.${domain}
            - **pgAdmin**: https://pr-${prNumber}.pgadmin.${domain}
            
            > **Note**: This environment will be automatically torn down when the PR is closed or the \`deploy-preview\` label is removed. Only one PR can have a preview environment active at a time.
            
            ---
            *Deployed by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  teardown:
    name: Teardown PR Preview
    runs-on: oci-hosted
    needs: validate-pr
    if: needs.validate-pr.outputs.should_teardown == 'true'
    steps:
      - name: Set up environment
        run: |
          PR_NUMBER="${{ needs.validate-pr.outputs.pr_number }}"
          DOMAIN="${{ vars.DOMAIN || 'preview.example.com' }}"
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
          echo "PROJECT_NAME=pr-$PR_NUMBER" >> $GITHUB_ENV

      - name: Remove Caddy routes
        env:
          CADDY_API_URL: ${{ vars.CADDY_API_URL || 'http://localhost:2019' }}
        run: |
          chmod +x deploy/scripts/remove-routes.sh
          ./deploy/scripts/remove-routes.sh "$PR_NUMBER" || {
            echo "Failed to remove routes, but continuing..."
          }

      - name: Stop and remove containers
        run: |
          echo "Tearing down PR #$PR_NUMBER..."
          docker compose -p "$PROJECT_NAME" -f docker-compose.pr.yml down -v || {
            echo "Failed to tear down, but continuing..."
          }

      - name: Comment on PR
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ needs.validate-pr.outputs.pr_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = process.env.PR_NUMBER;
            
            const comment = `## ðŸ§¹ PR Preview Environment Removed
            
            The preview environment for this PR has been torn down and all resources have been cleaned up.
            
            ---
            *Cleaned up by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

